## 点赞功能

选取技术栈：

Redis的 set sortedSet 

#### 实现需求

1. 点赞只能点一次，再次点击就会取消点赞
2. 查询Blog时要显示是否点赞
3. 进入Blog要显示一个点赞排行榜



#### 需求分析

##### 1.只赞一次

点赞完就会进入已经点赞的状态，不可重复点赞。使用Redis的 set 把用户的Id放入set中确保唯一性。

#####  2. 查询Blog时要显示是否点赞

维持一个标识，查询的时候要查看标识是 true 还是 false， true就显示已经赞过

##### 3. 显示一个点赞排行榜

点赞排行榜的实现要由排序性 。因此要有一个有序的集合或者列表来 keep

选用Redis的SortedSet ， 用点赞时间作为score来排序 。

点赞排行榜要显示用户的头像，需要借用UserDTO的icon属性

因此要查询MySQL数据库，从SortedSet中选取 5个 用户id，从MySQL 中查询用户并保存到DTO中

**但是MySQL检索后会根据id大小排序**，并不是按照score的时间先后排序的

所以要指定排序顺序



#### 实现

##### 1.只赞一次

```java
@Override
public Result likeBlog(Long Blogid){
	//get userId
    Long userId = UserHolder.getUser().getId();
    //keep a SortedSet to make the like only
    Double score = stringRedisTemplete.OpsForZset().score(key,userId.tostring());
    //if score exists ,the user never like the blog
    if(score ==null){
        boolean isSuccess = update().setSql("liked = liked+1").eq("id",BlogId).update();
        if(isSuccess){stringRedisTemplete.OpsForZset().add(key,userId.toString());}
    }else{
        boolean isSuccess = update().setSql("liked = liked-1").eq("id",BlogId).update();
        if(isSuccess){stringRedisTemplete.OpsForZset().remove(key,userId.toString());}
    }
	return Result.Ok();
}
```

##### 2.显示是否赞过

```java
//need to set the property of Blog , 
private isBlogLiked(Blog blog){
    //get current user id
    Long userId = UserHolder.getUser().getId();
    //if is liked
    Double score = stringRedisTemplete.OpsForZset().score(key,userId.tostring());
    //if score exists ,the user never like the blog
    blog.setIsLike (score!=null);
}
```

在显示博客的时候要显示是否点赞

```java
public Result queryBlogById(Long id){
   	//get the blog
    //get and set the user name、icon
    ...
    // show if liked
     isBlogLiked(blog);
    return Result.ok(blog);
}

public Result queryHotBlog(Integer num){
    //分页查询
    Page<Blog> page = query().orderByDesc("liked").page(new Page<>(num,Max_Page_size));
    //get current page 	
    List<Blog> records = page.getRecords();
    records.forEach(
    	blog->{
            this.queryBlogUser(blog	),
            this.isBlogLiked(blog)
        }
    )
}
```



##### 3. 点赞排行榜

```java
public Result queryBlogLikes(Long blogId){
    //get the users id
 	Set<String> ids = stringRedisTemplete.OpsForZset().range(key,0,4);
    //final goal is to return a userList  , even a empty list is ok
    if(ids ==null || ids.isEmpty()){
        return Result.ok(Collections.EmptyList());
    }
    //convert the ids from string to Long
    List<Long> LongIds = ids.stream().map(Long::ValueOf).collect(Collecetors.toList());
	//get the users from mysql
    List<UserDTO> users = listById(LongIds).stream()
        .map(user -> BeanUtil.copyProperties(user,UserDTO.Class))
        .collect(Collectors.toList());
    return Result.ok(users);
}
```

